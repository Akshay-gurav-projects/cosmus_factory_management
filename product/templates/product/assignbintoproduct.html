{% extends 'product/base.html' %}
{% load static %}

{% block body %}
<div class="row mt-4">
  <div class="col-lg-6 mt-2">
   
    <form action="" method="POST" id="subCategoryForm">
      {% csrf_token %}
      <div class="d-flex mb-3">
        <label for="id_product_main_category" class="item-form">Main Category:</label>
        <select name="product_main_category" id="id_product_main_category" class="item-select">
          {% if form.instance.id %}
          <option value="{{form.instance.product_main_category.id}}">{{form.instance.product_main_category.product_category_name}}</option>
          {% for main_cat in main_categories %}
          <option value="{{main_cat.id}}">{{main_cat.product_category_name}}</option>
          {% endfor %}

          {% elif not form.instance.id %}
          <option value=""></option>
          {% for main_cat in main_categories %}
          <option value="{{main_cat.id}}">{{main_cat.product_category_name}}</option>
          {% endfor %}
          {% endif %}
        </select>

      </div>



      <div>

    <div class="d-flex mb-3">
        <label for="id_product_sub_category_name" class="item-form">Sub Category:</label>
        <select name="sub_category" id="id_sub_category" class="item-select">
        
            <option value=""></option>
            {% for category in sub_category %}
            <option value="{{ category.id }}">{{ category.product_sub_category_name }}</option>
            {% endfor %}

        </select> 
    </div>


    <div class="d-flex mb-3">
        <label for="" class="item-form">Select Zone:</label>
        <select name="zone" id="id_zone" class="item-select">
        
            <option value=""></option>
            {% for zone in zones %}
            <option value="{{ zone.id }}">{{ zone.zone_name }}</option>
            {% endfor %}

        </select>    
    </div>


    <div class="d-flex mb-3">
        <label for="" class="item-form">Select Rack:</label>
        <select name="rack" id="id_rack" class="item-select">
        
          <option value=""></option>
          {% for rack in rack %}
          <option value="{{ rack.id }}">{{ rack.rack_name }}</option>
          {% endfor %}

      </select>  
    </div>



    <div class="mt-2">
        
        <table class="table table-bordered table-striped table-hover">
            <thead class="name_absolute">
                <tr>
                <th>Bin Name</th>
                <th>Bin Size</th>
                <th>checkBox</th>
                </tr>
            </thead>
            <tbody class="mainTableList" id="checkboxTable">
            {{ formset.management_form }}
            {% for form in formset %}
            {% comment %} {{form.id}} {% endcomment %}
                {{ form.as_p }}
            {% comment %} <tr>
                <td><input type="text" class="productShadeCutting_Material_input" name="{{form.prefix}}-bin_name" value="" maxlength="30" id="id_{{form.prefix}}-bin_name" readonly></td>

                <td> <input type="number" class="purchase-amount" name="{{form.prefix}}-product_size_in_bin" value="" id="id_{{form.prefix}}-product_size_in_bin"></td>

                <td> 
                <input type="checkbox" class="px-3" name="{{form.prefix}}-check_if_added_value" id="id_{{form.prefix}}-check_if_added_value" value="">

                <input type="hidden" class="px-3" name="{{form.prefix}}-check_if_added" id="id_{{form.prefix}}-check_if_added" value="">

                <input type="hidden" class="px-3" name="{{form.prefix}}-check_if_added_all" id="id_{{form.prefix}}-check_if_added_all" value="">

                <i style="display: none;" class="fa-solid fa-check-double fa-xl my-2 ms-2 iconClass text-danger"></i>
                </td>
                
            </tr> {% endcomment %}
            {% endfor %}
            </tbody>
        </table>

    </div>


      </div> 
      <button type="submit" id="submitButtonSubCategory" class="create-btn" name="save" value="Save">Save</button>     
    </form>
  </div>
  


  <form action="">
    <div id="formset-container"></div>

  </form>

<script>

  $(document).ready(function(){

    $('#id_product_main_category').on('change', function() {
    var mainProduct = $(this).val();

    $.ajax({
        url: "/assignbintoproduct/",
        method: "GET",
        data: {
            "mainProduct": mainProduct,
        },
        success: function(response) {
            console.log('Response:', response);
            var data =response.sub_category_data;
            var subCategory = $('#id_sub_category');
          
            subCategory.empty();

            subCategory.append('<option value="">Select Subcategory</option>');

            // Append new options from the response
            for (var i = 0; i < data.length; i++) {
                subCategory.append('<option value="' + data[i].id + '">' + data[i].name + '</option>');
            }
        },
        error: function(error) {
            console.log('Error:', error);
        }
    });
});

    $('#id_zone').on('change',function(){
  
      var mainZone = $(this).val();
   
    $.ajax({
      url : "/assignbintoproduct/",
      method : "GET",
      data : {
        "mainZone":mainZone,
      },
      success:function(response){
            console.log(response)
            var rackData = response.racks_data;
          var rack = $('#id_rack')
          rack.empty();
          rack.append('<option value="">Select Rack</option>')
          for(var i= 0 ; i < rackData.length;i++){
            rack.append('<option value ="' + rackData[i].id +'"> '+  rackData[i].name +'</option>')
          }

      },
      error:function(error){

      }

    })
})


$('#id_sub_category').on('change',function(){
    var rack = $('#id_rack').val();
    var subProduct = $(this).val();
    console.log('subProduct',subProduct)

    

    $.ajax({
      url : "/assignbintoproduct/",
      method : "GET",
      data : {
        "subProduct":subProduct,
        "rack" : rack,
      },
      success:function(response){

      },
      error:function(error){

      }

    })
})



{% comment %} $('#id_rack').on('change',function(){
    
    var rack = $(this).val();
    console.log('rack',rack)
  $.ajax({
    url : "/assignbintoproduct/",
    method : "GET",
    data : {
      "rack":rack,
    },
    success:function(response){

    },
    error:function(error){

    }

  })
}) {% endcomment %}




$('#id_rack').on('change', function() {
    var rack = $(this).val();
    var subProduct = $('#id_sub_category').val();

    if (!subProduct) {
        alert("Please select a subcategory first.");
        return;
    }

    $.ajax({
        url: "/assignbintoproduct/",
        method: "GET",
        data: {
            "rack": rack,
            "subProduct": subProduct,
        },
        success: function(response) {
            const formsetContainer = document.getElementById('formset-container');
            formsetContainer.innerHTML = '';  // Clear any existing forms

            response.formset_data.forEach(form => {
                const formDiv = document.createElement('div');
                formDiv.classList.add('form-group');

                for (const [fieldName, fieldHTML] of Object.entries(form)) {
                    const fieldContainer = document.createElement('div');
                    fieldContainer.innerHTML = fieldHTML;
                    formDiv.appendChild(fieldContainer);
                }

                formsetContainer.appendChild(formDiv);
            });
        },
        error: function(error) {
            console.log("Error:", error);
        }
    });
});

  })
</script>

{% endblock body %}